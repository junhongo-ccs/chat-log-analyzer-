# チャットログ分析ツール - 技術仕様書

## 1. プロジェクト概要

### 1.1 目的
仮想ヘルプAI（農業サポートシステムなど）の会話ログを分析し、ユーザーの困りごとや頻出する質問を可視化することで、システムのUI/UX改善につなげる。

### 1.2 対象
お客様への提案用プロトタイプ（デモンストレーション）

### 1.3 想定ユースケース
- システム管理者がヘルプデスク会話ログを定期分析
- 頻出する問い合わせからUI問題点を発見
- データドリブンなシステム改善提案

---

## 2. 技術スタック

### 2.1 フロントエンド・UI
| 技術 | バージョン | 用途 |
|------|-----------|------|
| Streamlit | 1.30+ | WebアプリケーションUI |
| Plotly | 5.18+ | インタラクティブグラフ表示（円グラフ） |

### 2.2 バックエンド・データ処理
| 技術 | バージョン | 用途 |
|------|-----------|------|
| Python | 3.10+ | メイン開発言語 |
| pandas | 2.1+ | データ処理・集計 |
| Janome | 0.5+ | 日本語形態素解析 |

### 2.3 AI・機械学習
| 技術 | バージョン | 用途 |
|------|-----------|------|
| Google Gemini API | 2.0+ (Gemini Pro) | カテゴリ自動分類 |
| google-generativeai | 最新 | Gemini API クライアント |

### 2.4 データストレージ
| 技術 | 用途 |
|------|------|
| CSV | サンプルデータ保存（メンテナンス容易） |
| メモリ（pandas DataFrame） | ランタイムデータ処理 |

### 2.5 デプロイ・ホスティング
| サービス | 用途 |
|----------|------|
| GitHub | ソースコード管理 |
| Streamlit Cloud | 無料ホスティング（公開デモ用） |

---

## 3. 機能要件書

### 3.1 必須機能

#### F-001: データ取得演出
- **概要**: チャットログをリアルタイム取得しているかのような視覚効果
- **実装**: 
  - 「データ取得中...」プログレスバー表示（2-3秒）
  - データソース表示（例: "Slack #customer-support"）
  - 最終取得日時のタイムスタンプ
- **目的**: プロトタイプのリアリティ向上

#### F-002: キーワード抽出・ランキング
- **概要**: 会話ログから重要キーワードを抽出し頻度順に表示
- **実装**:
  - Janomeで形態素解析（名詞・動詞を抽出）
  - ストップワード除外（「です」「ます」など）
  - 頻度カウント → TOP 10-20 表示
- **UI**: テーブル形式（キーワード / 出現回数 / 割合）

#### F-003: AIカテゴリ自動分類
- **概要**: Gemini APIで会話内容を5カテゴリに自動分類
- **カテゴリ定義**:
  1. **操作方法** - 「どこ」「どうやって」「やり方」
  2. **機能の場所** - 「ボタン」「メニュー」「見つからない」
  3. **エラー/トラブル** - 「エラー」「できない」「表示されない」
  4. **機能要望** - 「欲しい」「追加」「改善」
  5. **その他** - 上記以外
- **実装**:
  - 各メッセージをGemini APIに送信
  - プロンプト: 「以下のメッセージを5カテゴリに分類してください」
  - レスポンスをパース → 集計
- **UI**: 円グラフ（カテゴリ名 / 件数 / 割合）

#### F-004: 期間フィルタ
- **概要**: 日付範囲でデータを絞り込み
- **UI**: サイドバーに日付選択UI
  - 開始日・終了日を選択
  - 「フィルタ適用」ボタン
- **動作**: フィルタ後に全グラフ・ランキングを再計算

#### F-005: 詳細ログ表示
- **概要**: カテゴリをクリックすると該当ログの詳細を表示
- **実装**:
  - 円グラフセクションクリック → expanderで展開
  - 該当するメッセージ一覧を表示（タイムスタンプ / ユーザーID / 内容）
- **UI**: 折りたたみ式の詳細パネル

#### F-006: データエクスポート
- **概要**: 分析結果をCSVダウンロード
- **実装**:
  - 「エクスポート」ボタン設置
  - 出力内容:
    - キーワードランキング
    - カテゴリ別集計
    - フィルタ適用後のログ
- **フォーマット**: CSV（日本語対応、UTF-8 BOM付き）

---

## 4. システムアーキテクチャ

### 4.1 全体構成図（テキスト表現）

```
┌─────────────────────────────────────────────┐
│            Streamlit Web UI                 │
│  ┌─────────────────────────────────────┐   │
│  │  Header (Title, Timestamp)          │   │
│  ├─────────────────────────────────────┤   │
│  │  Sidebar                            │   │
│  │  - 期間フィルタ                      │   │
│  │  - データエクスポートボタン          │   │
│  ├─────────────────────────────────────┤   │
│  │  Main Area                          │   │
│  │  ┌─────────────────────────────┐    │   │
│  │  │ データ取得演出エリア        │    │   │
│  │  └─────────────────────────────┘    │   │
│  │  ┌─────────────────────────────┐    │   │
│  │  │ キーワードランキング        │    │   │
│  │  │ (Table)                     │    │   │
│  │  └─────────────────────────────┘    │   │
│  │  ┌─────────────────────────────┐    │   │
│  │  │ カテゴリ別円グラフ          │    │   │
│  │  │ (Plotly Pie Chart)          │    │   │
│  │  └─────────────────────────────┘    │   │
│  │  ┌─────────────────────────────┐    │   │
│  │  │ 詳細ログ表示（展開式）      │    │   │
│  │  └─────────────────────────────┘    │   │
│  └─────────────────────────────────────┘   │
└─────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────┐
│          Data Processing Layer              │
│  ┌─────────────┐  ┌─────────────────────┐  │
│  │ analyzer.py │  │ CSV Data Loader     │  │
│  │ - 形態素解析 │  │ (pandas)            │  │
│  │ - 集計処理  │  └─────────────────────┘  │
│  └─────────────┘                            │
│         ↓                                   │
│  ┌─────────────────────────────────────┐   │
│  │    Gemini API Integration           │   │
│  │    - カテゴリ分類プロンプト          │   │
│  │    - レスポンスパース                │   │
│  └─────────────────────────────────────┘   │
└─────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────┐
│              Data Layer                     │
│  data/sample_chat.csv                       │
│  ┌──────────────────────────────────────┐  │
│  │ timestamp | user_id | message        │  │
│  │ 2026-01-01 10:15 | user001 | ...    │  │
│  └──────────────────────────────────────┘  │
└─────────────────────────────────────────────┘
```

### 4.2 データフロー

```
1. CSVロード (pandas.read_csv)
   ↓
2. 期間フィルタ適用（ユーザー選択に応じて）
   ↓
3. 形態素解析 (Janome)
   ↓
4. キーワード抽出・集計 (collections.Counter)
   ↓
5. Gemini API呼び出し（各メッセージのカテゴリ分類）
   ↓
6. カテゴリ集計
   ↓
7. Streamlit UI描画
   - テーブル (st.dataframe)
   - 円グラフ (plotly.graph_objects.Pie)
   - 詳細ログ (st.expander)
```

---

## 5. ファイル構成

```
chat-log-analyzer/
├── README.md                   # プロジェクト概要・セットアップ手順
├── requirements.txt            # Python依存パッケージ
├── .streamlit/
│   └── config.toml            # Streamlit設定（テーマなど）
├── app.py                      # メインアプリケーション（Streamlit UI）
├── analyzer.py                 # データ分析ロジック
│   ├── load_data()            # CSV読み込み
│   ├── extract_keywords()     # 形態素解析・キーワード抽出
│   ├── classify_category()    # Gemini APIカテゴリ分類
│   └── aggregate_data()       # 集計処理
├── data/
│   └── sample_chat.csv        # サンプルチャットログ
├── utils/
│   ├── gemini_client.py       # Gemini API クライアント
│   └── stopwords.py           # ストップワード辞書
└── assets/
    └── demo_loading.gif       # データ取得演出用画像（オプション）
```

---

## 6. データ構造

### 6.1 入力データ（CSV）

**ファイル名**: `data/sample_chat.csv`

**スキーマ**:
| カラム名 | 型 | 説明 | 例 |
|----------|-----|------|-----|
| timestamp | datetime | メッセージ送信日時 | 2026-01-01 10:15:23 |
| user_id | string | ユーザー識別子 | user001 |
| message | string | チャットメッセージ本文 | 登録ボタンはどこですか？ |

**サンプルレコード**:
```csv
timestamp,user_id,message
2026-01-01 10:15:23,user001,登録ボタンはどこにありますか？
2026-01-01 10:30:45,user002,エラーが表示されて進めません
2026-01-01 11:00:12,user003,メニューが見つかりません
2026-01-01 11:15:33,user004,データをエクスポートする方法を教えてください
2026-01-01 12:00:00,user005,検索機能が欲しいです
```

### 6.2 中間データ構造

#### キーワードランキング
```python
[
    {"keyword": "登録ボタン", "count": 30, "percentage": 15.5},
    {"keyword": "エラー", "count": 25, "percentage": 12.9},
    ...
]
```

#### カテゴリ集計
```python
{
    "操作方法": 45,
    "機能の場所": 38,
    "エラー/トラブル": 22,
    "機能要望": 18,
    "その他": 12
}
```

---

## 7. UI設計

### 7.1 レイアウト構成

#### ヘッダー
- タイトル: 「チャットログ分析ダッシュボード」
- サブタイトル: 「仮想ヘルプAI 会話ログ分析」
- データソース表示: 「データソース: 仮想ヘルプデスクチャット」
- 最終取得日時: 「最終取得: 2026-01-07 10:00:00」

#### サイドバー
- **期間フィルタ**
  - 開始日: `st.date_input("開始日")`
  - 終了日: `st.date_input("終了日")`
  - フィルタ適用ボタン: `st.button("フィルタ適用")`
- **データエクスポート**
  - ボタン: `st.download_button("CSVダウンロード")`

#### メインエリア
1. **データ取得演出セクション**
   - プログレスバー + "データ取得中..." テキスト
   - アニメーション（2-3秒）

2. **キーワードランキングセクション**
   - タイトル: "頻出キーワード TOP 10"
   - テーブル: 
     ```
     | 順位 | キーワード | 出現回数 | 割合 |
     |------|-----------|----------|------|
     | 1    | 登録ボタン | 30       | 15.5% |
     ```

3. **カテゴリ別分析セクション**
   - タイトル: "カテゴリ別集計"
   - 円グラフ（Plotly）
   - 各セクションクリック可能 → 詳細展開

4. **詳細ログセクション**
   - expanderで折りたたみ表示
   - カテゴリごとのログ一覧
   - カラム: タイムスタンプ | ユーザーID | メッセージ内容

### 7.2 カラー・テーマ
- **ベース**: Streamlitデフォルトテーマ
- **円グラフカラーパレット**: Plotly "Pastel" または "Set3"
- **アクセントカラー**: Google Material Design準拠（オプション）

---

## 8. API連携仕様

### 8.1 Gemini API

#### エンドポイント
```
google.generativeai.GenerativeModel("gemini-pro")
```

#### プロンプト例
```
以下のユーザーメッセージを、下記の5カテゴリのいずれか1つに分類してください。
カテゴリ名のみを返してください。

カテゴリ:
1. 操作方法
2. 機能の場所
3. エラー/トラブル
4. 機能要望
5. その他

メッセージ: "{user_message}"

分類結果:
```

#### レスポンス処理
- テキストレスポンスからカテゴリ名を抽出
- カテゴリ名が定義外の場合 → "その他"に分類
- API エラー時 → デフォルトで"その他"

#### レート制限対策
- バッチ処理（10-20件ずつ）
- プログレスバー表示
- エラーハンドリング（リトライ3回）

---

## 9. デプロイ手順

### 9.1 GitHub準備

1. **リポジトリ作成**
   ```bash
   git init
   git add .
   git commit -m "Initial commit"
   git remote add origin https://github.com/{username}/chat-log-analyzer.git
   git push -u origin main
   ```

2. **必須ファイル確認**
   - `requirements.txt`
   - `app.py`
   - `data/sample_chat.csv`

### 9.2 Streamlit Cloud デプロイ

1. **Streamlit Cloud アカウント作成**
   - https://streamlit.io/cloud
   - GitHubアカウントで認証

2. **アプリデプロイ**
   - "New app" → GitHubリポジトリ選択
   - メインファイル: `app.py`
   - Python version: 3.10

3. **環境変数設定（Secret）**
   - `GEMINI_API_KEY` を設定
   - Streamlit Cloud の "Settings" → "Secrets" に追加
   ```toml
   GEMINI_API_KEY = "your-api-key-here"
   ```

4. **デプロイ完了**
   - URL発行: `https://{app-name}.streamlit.app`
   - 自動ビルド・デプロイ（約2-3分）

---

## 10. 拡張機能案（将来実装）

### 10.1 フェーズ2
- リアルタイムチャット連携（Slack API / Teams API）
- 時系列トレンドグラフ（時間経過での変化）
- AI による改善提案自動生成

### 10.2 フェーズ3
- マルチテナント対応（複数システムログ分析）
- ダッシュボードカスタマイズ機能
- メール通知（異常値検知時）

---

## 11. 参考リソース

### 11.1 公式ドキュメント
- [Streamlit Documentation](https://docs.streamlit.io/)
- [Gemini API Documentation](https://ai.google.dev/docs)
- [Plotly Python](https://plotly.com/python/)
- [Janome Documentation](https://mocobeta.github.io/janome/)

### 11.2 デプロイガイド
- [Streamlit Cloud Deploy Guide](https://docs.streamlit.io/streamlit-community-cloud/get-started)

---

## 12. バージョン管理

| バージョン | 日付 | 変更内容 |
|-----------|------|----------|
| 0.1.0 | 2026-01-07 | 初版作成（仕様策定） |

---

**END OF SPECIFICATION**
